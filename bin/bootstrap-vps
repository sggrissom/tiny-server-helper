#!/usr/bin/env bash
set -euo pipefail

APPS_USER="${APPS_USER:-apps}"
APPS_ROOT="${APPS_ROOT:-/srv/apps}"

echo "== bootstrap-vps =="

# 1) Create apps user/group if missing
if ! id -u "$APPS_USER" >/dev/null 2>&1; then
  echo "Creating system user: $APPS_USER"
  sudo useradd --system --home "$APPS_ROOT" --shell /usr/sbin/nologin "$APPS_USER"
else
  echo "User exists: $APPS_USER"
fi

if ! getent group "$APPS_USER" >/dev/null 2>&1; then
  echo "Creating system group: $APPS_USER"
  sudo groupadd --system "$APPS_USER"
else
  echo "Group exists: $APPS_USER"
fi

# Ensure user is in its group (harmless if already)
sudo usermod -a -G "$APPS_USER" "$APPS_USER" || true

# 2) Create standard directories
echo "Ensuring directory layout..."
sudo mkdir -p "$APPS_ROOT"
sudo mkdir -p /etc/caddy/sites

# Ownership for apps root
sudo chown -R "$APPS_USER:$APPS_USER" "$APPS_ROOT"
sudo chmod 0755 "$APPS_ROOT"

# 3) Install/Update systemd template unit from repo
if [[ ! -f systemd/app@.service ]]; then
  echo "Error: run this from repo root (missing systemd/app@.service)" >&2
  exit 1
fi

echo "Installing systemd template: /etc/systemd/system/app@.service"
sudo cp systemd/app@.service /etc/systemd/system/app@.service
sudo systemctl daemon-reload

# 4) Ensure Caddyfile imports sites folder (non-destructive)
CADDYFILE="/etc/caddy/Caddyfile"
IMPORT_LINE="import /etc/caddy/sites/*.caddy"

if [[ -f "$CADDYFILE" ]]; then
  if sudo grep -qF "$IMPORT_LINE" "$CADDYFILE"; then
    echo "Caddyfile already imports sites folder."
  else
    echo "Adding sites import to Caddyfile."
    echo "" | sudo tee -a "$CADDYFILE" >/dev/null
    echo "$IMPORT_LINE" | sudo tee -a "$CADDYFILE" >/dev/null
  fi
else
  echo "Creating minimal Caddyfile with sites import."
  echo "$IMPORT_LINE" | sudo tee "$CADDYFILE" >/dev/null
fi

# 5) Validate/reload Caddy if installed; otherwise print next steps
if command -v caddy >/dev/null 2>&1; then
  echo "Validating Caddy config..."
  sudo caddy validate --config "$CADDYFILE"
  echo "Reloading Caddy..."
  sudo systemctl reload caddy || sudo systemctl restart caddy
else
  echo "NOTE: caddy not found. Install it, then:"
  echo "  sudo caddy validate --config $CADDYFILE"
  echo "  sudo systemctl enable --now caddy"
fi

echo "âœ… bootstrap-vps complete."
echo "Next: sudo appctl init <name> <port>"

