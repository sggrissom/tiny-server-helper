#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage:
  deploy <app_name> <user@host> <local_binary_path>

Examples:
  deploy resume vps ./build/resume
EOF
}

die(){ echo "Error: $*" >&2; exit 1; }

app="${1:-}"; host="${2:-}"; binpath="${3:-}"
[[ -n "$app" && -n "$host" && -n "$binpath" ]] || { usage; exit 1; }
[[ -f "$binpath" ]] || die "binary not found: $binpath"

keep=5

ts="$(date +%Y-%m-%d_%H%M%S)"
sha="nogit"
if command -v git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  sha="$(git rev-parse --short HEAD 2>/dev/null || echo nogit)"
fi
rel="${ts}_${sha}"

remote_root="/srv/apps/$app"
remote_rel="$remote_root/releases/$rel"
remote_bin="$remote_rel/$app"

echo "Deploying $app -> $host"
echo "  release: $rel"
echo "  keep:    $keep"

# Capture previous release (if any)
prev="$(ssh "$host" "readlink -f '$remote_root/current' || true")"

# Create release dir
ssh "$host" "sudo mkdir -p '$remote_rel'"
ssh "$host" "sudo chown -R apps:apps '$remote_rel'"

# Upload binary
tmp="/tmp/${app}.${rel}.$$"
scp -O "$binpath" "$host:$tmp"
ssh "$host" "sudo mv '$tmp' '$remote_bin' && sudo chmod +x '$remote_bin'"

# Activate release + restart
ssh "$host" "
  sudo ln -sfn '$remote_rel' '$remote_root/current' &&
  sudo systemctl restart 'app@$app'
"

echo "Waiting for health…"
if ! ssh "$host" "
  set -e
  source '$remote_root/shared/.env'
  curl -fsS --max-time 5 http://127.0.0.1:\$PORT/healthz
"; then
  echo "❌ Health check failed — rolling back"
  if [[ -n "$prev" ]]; then
    ssh "$host" "
      sudo ln -sfn '$prev' '$remote_root/current' &&
      sudo systemctl restart 'app@$app'
    "
  fi
  exit 1
fi

# Prune old releases
ssh "$host" "
  set -e
  cd '$remote_root/releases'
  ls -1dt * | tail -n +$((keep+1)) | xargs -r sudo rm -rf --
"

echo "✅ Done."
echo "Logs:"
echo "  ssh $host 'journalctl -u app@$app -f'"
echo "Current:"
echo "  ssh $host 'readlink -f $remote_root/current'"

